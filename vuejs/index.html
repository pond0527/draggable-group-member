<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vuedemo</title>

    <!-- BootStrap Stylesheets -->
    <link rel="stylesheet" href="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css">
    <script src="//code.jquery.com/jquery-3.3.1.slim.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js"></script>
    <script src="//stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js"></script>

    <!-- TODO: Vue3系ではうまく表示できなかった -->
    <!-- draggable lib include CDN -->
    <!-- <script src="//unpkg.com/vue@next"></script> -->
    <!-- <script src="//cdn.jsdelivr.net/npm/sortablejs@1.10.2/Sortable.min.js"></script> -->
    <!-- CDNJS :: Vue.Draggable (https://cdnjs.com/) -->
    <!-- <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/4.0.0/vuedraggable.umd.min.js"></script> -->
    <script src="//cdnjs.cloudflare.com/ajax/libs/vue/2.5.2/vue.min.js"></script>
    <script src="//cdn.jsdelivr.net/npm/sortablejs@1.8.4/Sortable.min.js"></script>
    <script src="//cdnjs.cloudflare.com/ajax/libs/Vue.Draggable/2.20.0/vuedraggable.umd.min.js"></script>
</head>

<h1>グループ生成</h1>
<body class="container">
    <div id="inputForm">
        <form class="form-inline">
            <table class="table table-borderless table-responsive">
                <tbody>
                    <tr>
                    <td scope="col">グループ数を入力して下さい</td>
                        <td scope="col">
                            <input class="form-control mb-2 mr-sm-2" type="number" v-model="inputGrpNum" id="grupNum"/>
                        </td>
                    </tr>
                    <tr>
                        <td scope="col">メンバー入力して下さい</td>
                        <td scope="col">
                            <textarea class="form-control" v-model="inputMembers"></textarea>
                        </td>
                    </tr>
                    <tr >
                        <td>
                            <button class="btn" type="button" @click="makeGroupMembers">作成</button>
                            <button class="btn" type="reset" @click="clearGroupMembers">クリア</button>
                        </td>
                    </tr>
                </tbody>
            </table>
        </form>
    </div>

    <div id="app">
        <div v-show="!isEmpty">
            <table class="table table-sm table-responsive" v-model="memberGroups">
                <thead class="thead-light">
                    <tr>
                      <th scope="col">グループID</th>
                      <th scope="col" colspan="100">メンバー</th>
                    </tr>
                </thead>

                <tbody 
                    v-for="(members, idx) in memberGroups"
                    :key="idx">
                    <tr
                        tag="tr"
                        is="draggable" 
                        :options="{group:'group', animation: 150}"
                        :move="onMove"
                        @end="drag=draggableEnd" 
                        >
                        <td scope="row">{{ idx+1 }}</td>
                        <td class="dragArea"
                            v-for="member in members" :key="member.id">
                            {{ member.name }}
                        </td>
                    </tr>
                </tbody>

            </table>
            
            <button @click="check" class="btn">Check</button>
        </div>
    </div>
</body>

<script>
    var app = new Vue({
        el: "#app",
        data: {
            memberGroups: []
        },
        methods:{
            check: function() {
                for(i=0; i < this.groupNum; i++) {
                    var grpMembers = this.tasks[i];
                    console.log(grpMembers);
                    for(var idx in grpMembers) {
                        console.log(grpMembers[idx].name);
                    }
                }
            },
            draggableEnd(event) {
                console.log(event.from);
                console.log(event.to);
            },
            onMove() {
                console.log("relatedContext");
            },
            updateGroupMembers(grpId, members) {
                this.$set(this.memberGroups, grpId, members);
            },
            clearGroupMembers() {
                Object.keys(this.memberGroups).forEach(grpId => {
                    this.$delete(this.memberGroups, grpId)
                })
            }
        },
        computed: {
           isEmpty: function () {
              return this.memberGroups.length == 0;
           }
       }
    });
    
    var inputForm = new Vue({
        el: "#inputForm",
        data: {
            inputGrpNum: 0,
            inputMembers: undefined
        },
        methods: {
            makeGroupMembers: function() {
                var wkMembers = this.inputMembers.replace('/\r\n|\r/g', "\n").split('\n');
                // wkMembers = wkMembers.filter(Boolean);
                wkMembers = this._shuffle(wkMembers.filter(Boolean));
                let maxGrpBoxCnt = wkMembers.length / this.inputGrpNum

                var grpBoxCnt = 0
                var memberCnt = 0
                for(var j=0; j < this.inputGrpNum; j++) {
                    var wkList = []
                    for(; memberCnt < wkMembers.length; ) {
                        if(wkList.length >= maxGrpBoxCnt){
                            break
                        }
                        wkList.push({ id: memberCnt, name: wkMembers[memberCnt]});
                        memberCnt++
                    }

                    if(wkList.length === 0) { continue }
                    app.updateGroupMembers(grpBoxCnt, wkList);

                    grpBoxCnt++
                }
            },
            clearGroupMembers: function() {
                // プロパティを全削除 
                this.inputGrpNum = 0;
                this.inputMembers = undefined;
                app.clearGroupMembers();
            },
            _shuffle(orgList) {
                var newList = [];

                while (orgList.length > 0) {
                    n = orgList.length;
                    k = Math.floor(Math.random() * n);

                    newList.push(orgList[k]);
                    orgList.splice(k, 1);
                }

                return newList;
            }
        }
    });
</script>

<style>
    .dragArea:hover {
        background-color: ta;
    }
    </style>

</html>